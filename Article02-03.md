# ドメイン・コンテキストビュー

前述のとおり、本稿ではアーキテクチャ設計の基本方針としてドメイン駆動設計を適用します。

今回の設計範囲は購買ドメインです。ドメイン・コンテキストビューでは、購買ドメインとAdventureWorks社内の他のドメインの関係性をドメイン駆動設計の「境界付けられたコンテキスト」を利用して表現します。

予算編でも説明した通り、ドメインとは何らかの問題領域のことで、ビジネスにおける感心の単位と言っても良いでしょう。

ドメインには、ドメインを表現するコンテキスト（文脈）が含まれます。コンテキストにはそのドメインを表現する名前や振る舞い（つまりオブジェクト）が定義されます。

購買ドメインの「境界付けられたコンテキスト」は下図のように定義します。予算編で一度解説していますので詳細は省略します。[予算編を参照](https://codezine.jp/article/detail/16953?p=3&anchor=1)してください。

![](/Article02/スライド10.PNG)

ただ予算編と比較して、下記の2点を変更しています。

1. 購買・認証・製造・販売の共通する概念としてAdventureWorksドメインとコンテキストを定義
2. 製造・販売コンテキストから認証コンテキストの依存線を削除

前者については、AdventureWorks全社に共通するオブジェクトを定義するコンテキストとして導出しました。

基本的に企業にとってプリミティブなオブジェクトを定義し、複雑なオブジェクトはそれぞれの業務ドメイン内で定義することも検討してください。

これはたとえば商品のようなオブジェクトは、一見全社共通のオブジェクトに見えますが、じつはコンテキストごとに必要な属性や振る舞いが大きく異なるからです。そのため、一部のコードは本来であれば共通化できるかもしれませんが、変更の容易性なども考慮すると個別の業務ドメイン側で、それぞれに必要な内容のみを実装するようにするほうが好ましいです。

AdventureWorksコンテキストには、具体的にはつぎのようなオブジェクトを定義します。

|オブジェクト|説明|
|--|--|
|Date|時刻を持たない年月日|
|Days|日数|
|Dollar|通貨（日本企業の場合はYenなど）|
|Gram|重量グラム|
|DollarPerGram|グラム当たりの料金|

これらのオブジェクトをドメイン駆動設計のValue ObjectやEntityとしてAdventureWorksコンテキストに実装します。先に記載したとおり、複雑なオブジェクトは業務ドメイン内に可能な限り実装したほうが良いため、ほとんどはValue Objectになるでしょう。

さて、ここでは全社共通のコンテキストを定義しました。しかし変更容易性を優先する場合は、上記のオブジェクトも業務コンテキストにあえて定義する方式も考えられます。

生産性と変更容易性はトレードオフの関係になりやすいです。この辺りは共通部分に破壊的変更が入りやすいかどうか判断したらよいと思います。今回は前述のようなプリミティブなValue Objectであれば共通化したほうが品質も含めてメリットが多いと判断したため、AdventureWorksコンテキストを導出することとしました。

後者の「製造・販売コンテキストから認証コンテキストの依存線を削除」について。

これはそもそも購買コンテキストからは製造や販売のコンテキストの先がどのような依存関係にあるか意識したくないためです。実際には依存関係がある分けですが、購買コンテキストのアーキテクチャ設計としては、そこを意識せず行うために削除しました。

予算時に削除しても良かったのですが、全社の境界付けられたコンテキストでは重要な要素で、全社から購買ドメインの境界付けられたコンテキストを抽出する際に削除しても見積上影響がないため手を付けませんでした。

これらのコンテキストをどのようにコードに落とし込むかは、論理ビュー・配置ビュー・実装ビューの中で説明します。

# ユースケースビュー

ユースケースビューでは、システムのアーキテクチャを決定するためにパターンの導出と、アーキテクチャ設計を進める上で代表となるユースケースを選定します。

ユースケースとは、利用者にとってシステムを利用する価値を表し、1つ以上の機能の組み合わせによって提供されます。

ユースケースと機能は明確に異なります。たとえば注文を発注する際に、発送方法をプルダウンで選択するとします。これは明確に「機能」ですが、利用者の最終的な価値にはなりません。ユースケースとはあくまでも利用者に価値を提供するための、1つ以上の機能の集合を表すものとします。

私たちが実現すべきものは機能ではなく、ユーザーに提供する価値だと考えています。そのため機能ビューではなく、ユースケースビューとして扱います。

ユースケースビューは、ユースケース図を完成させることではありません。ユースケースは、ユースケース仕様書（一般的な機能定義書のレイヤーに類するドキュメント）で作成されているものとします。

ユースケースビューでは、ユースケース仕様書で導出されたユースケースの一覧に対して、それぞれのユースケースをどのパターンで実装するか選択し、パターン内で実装ビューを例示する代表的なユースケースを決定します。

つぎのような表を用いると表現しやすいかと思います。

|No.|ユースケース|パターン|代表|説明|
|--|--|--|--|--|
|1|発注する|基本パターン|||
|2|再発注する|基本パターン|✅|アーキテクチャを検討する上で、基本パターンとして必要な内容が含まれており、かつ、最小のユースケースであるため|
|3|・・・|・・・|||
|4|・・・|・・・|||

すべてのユースケースを一覧として記載し、それぞれのユースケースのパターンを抽出・割り当てます。類似したユースケースを同一のパターンに割当て、アーキテクチャの検討は、同一パターン内の代表的なユースケースを用いて設計します。

アーキテクチャを設計するにあたり、つねにすべてのユースケースを検討しつつ進めることは困難ですし、新たらしいユースケースが追加された場合に全面的に見なおすことも困難です。パターンを用いることでそれらの課題を緩和します。

そのうえで、この後のアーキテクチャを設計する際に利用する代表的なユースケースを決定します。抽象化されたパターンだけでは擬態的な検討が、不足する可能性があります。そのため、代表的なユースケースを決定することでアーキテクチャを具体化します。

代表的なユースケースは、パターンに必要な要素が含まれた最小のユースケースを選定することが好ましいでしょう。ただ、そう都合の用意ユースケースが存在しない場合もあります。多少の大小は目をつぶり、一部不足するような場合は、不足部分を別途補えば良いかと思います。

# 非機能要件ビュー

ユースケースビュー同様、非機能要件を定義するものではありません。非機能要件定義書などで定義された非機能要件のうち、WPFアプリケーションのアーキテクチャ上で考慮が必要な要件を明確にします。

非機能要件の定義について詳しく記載することはここではかないませんが、たとえばIPAの公開している「[非機能要求グレード](https://www.ipa.go.jp/sec/softwareengineering/std/ent03-b.html)」を参考に非機能要件を抽出し、システム独自で検討が必要なものを追加すると、扱いやすいと私は考えています。

非機能要件は、WPFアプリケーション側ですべて実現するものとは限りません。どちらかというとサーバーサイド側で検討する項目が多いでしょう。

非機能定義書で定義された非機能要件のうち、WPFアーキテクチャ上で検討するべき要件がどれか？不要な場合、なぜ不要なのかを明確にすることが非機能要件ビューの目的となります。

つぎのような表を用いると表現しやすいかと思
います。

|大項目|中項目|小項目|指標|考慮|説明|
|:-:|:-:|:-:|--|:-:|--|
|可用性|・・・|・・・|・・・|||
|性能・拡張性|性能目標値|オンラインスループット|通常時処理余裕率|不要|サーバーサイドにて実現を検討し、WPF上での考慮は不要。|
|運用・保守性|通常運用|運用監視|監視情報|要|WPF上でのエラーとトレース情報を適切にサーバーサイドにログとして保管する。そのため抜け漏れのない例外処理も併せて、配置ビュー・実装ビューにて設計する。|
||その他の運用管理方針|機能追加・変更容易性|影響範囲の限定|要|WPFアプリケーションを構成するコンポーネント間の疎結合と依存方向を明確にし、それに反した実装を行えないよう制限することで、機能の追加・変更を容易にする。おもに論理ビュー・配置ビューにて設計する。|
||||ビルド・テストの自動化|要|機能の追加・変更後のテストを容易にするため、ビルド・テストを自動化する。実装ビューにて設計する。|
|セキュリティ|アクセス・利用制限|認証機能|管理権限を持つ主体の認証|要|WPFアプリケーションの利用者を認証する。認証機能は全機能共通機能として提供する。配置ビュー・実装ビューにて設計する。本来は全機能共通のアーキテクチャ設計上で実施するが、便宜上本稿に記載する。|
||||管理権限を持たない主体の認証|要|同上|
|・・・|・・・|・・・|・・・|||

上記は非機能要件の一部の抜粋です。基本的にIPAの非機能要件グレードにしたがっていますが、一部は非機能要件グレードには含まれない項目も追加しています。

具体的には機能の追加・変更容易性です。こちらで機能追加や変更が発生した場合に、影響範囲を限定することと、ビルド・テストを自動化することで生産性や品質の向上を図る必要が求められており、その要件に則って各ビューで要件の実現手段を設計します。

表情には非機能要件ごとに、WPFアプリケーション上で考慮の要否を記載します。

考慮が必要な場合は、どのビューでその要件を設計するか明記することで、設計の抜け漏れを防ぐとともに、閲覧の際のインデックスとしても利用します。考慮が不要な場合は、その理由を明記します。

考慮の要否以上に、なぜ決定したかその理由の方が後々重要になるため、しっかり書き残しておきましょう。
